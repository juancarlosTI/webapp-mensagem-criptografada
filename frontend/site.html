<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hello</title>
</head>

<body>
    <header>
        <section class="header-bar">
            <form id="login-form">
                <label for="login">Login: </label>
                <input type="text" name="login-user" id="login">

                <label for="email">Email: </label>
                <input type="text" name="email-user" id="email">

                <button type="submit">OnSubmit</button>
            </form>
        </section>
    </header>
    <section class="exibition">
        <div class="chaves">
            <p class="chave-privada">Chave privada : <span id="chave-privada"></span></p>
            <p class="chave-publica">Chave publica : <span id="chave-publica"></span></p>
            <button id="btnGerarChaves">Gerar chaves</button>
        </div>
    </section>
    <section>
        <textarea name="write-message" id="write-message">
            Escreva uma mensagem!
        </textarea>
    </section>

    <script>
        const form = document.getElementById('login-form');
        const keys = document.getElementById('btnGerarChaves');
        form.addEventListener('submit', verifyUser);
        keys.addEventListener('gerar', buildKeys);

        async function verifyUser(event) {
            event.preventDefault();

            const login = document.getElementById('login').value;
            const email = document.getElementById('email').value;

            if (!login || !email) {
                alert("Preencha login e email!");
                return;
            }

            try {
                const response = await fetch('http://localhost:3000/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include', // para enviar cookies/sessão
                    body: JSON.stringify({ email })
                });

                if (!response.ok) {
                    throw new Error(`Erro: ${response.status}`);
                }

                const data = await response.json();
                alert(`Bem-vindo, ${data.id} ${data.nome}!`);
            } catch (err) {
                console.error(err);
                alert("Erro ao logar: " + err.message);
            }
        }

        async function buildKeys() {
            const chave_privada = document.getElementById('chave-privada');
            const chave_publica = document.getElementById('chave-publica');

            const valor1 = 'oi'
            const valor2 = 'tchau'

            const response = await fetch('http://localhost:3000/criptografia/createKeys', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include', // para enviar cookies/sessão
            });
            if (!response.ok) {
                throw new Error(`Erro na requisição: ${response.status}`);
            }

            const data = await response.json();
            console.log(data);

            if (!data) {
                return "Sem dados"
            }

            chave_privada.innerHTML = data.priv_pem;
            chave_publica.innerHTML = data.pub_pem;

        }
        document.getElementById('btnGerarChaves').addEventListener('click', buildKeys);
    </script>
</body>

</html>